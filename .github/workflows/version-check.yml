name: Version Check

on:
  pull_request:
    paths:
      - 'package.json'
      - 'version.json'
  push:
    branches:
      - main
    paths:
      - 'package.json'
      - 'version.json'

jobs:
  check-version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Get current version
        id: current-version
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # PR version
            VERSION=$(jq -r .version package.json)
            echo "PR version: $VERSION"
          else
            # Push to main, validate commit version against previous main
            git fetch origin main~1
            git checkout origin/main~1 -- package.json
            VERSION=$(jq -r .version package.json)
            echo "Previous main version: $VERSION"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Get main branch version
        run: |
          git fetch origin main
          git checkout origin/main -- package.json
          MAIN_VERSION=$(jq -r .version package.json)
          echo "MAIN_VERSION=$MAIN_VERSION"
          echo "MAIN_VERSION=$MAIN_VERSION" >> $GITHUB_ENV

      - name: Compare versions
        run: |
          PR_VERSION="$VERSION"
          echo "PR/commit version: $PR_VERSION"
          echo "Main branch version: $MAIN_VERSION"

          # Split versions into arrays
          IFS='.' read -r -a pr <<< "$PR_VERSION"
          IFS='.' read -r -a main <<< "$MAIN_VERSION"

          for i in 0 1 2; do
            if [ "${pr[i]}" -gt "${main[i]}" ]; then
              echo "Version check passed âœ…"
              exit 0
            elif [ "${pr[i]}" -lt "${main[i]}" ]; then
              echo "::error ::Version check failed: $PR_VERSION <= $MAIN_VERSION"
              exit 1
            fi
          done

          # If we reach here, versions are equal
          echo "::error ::Version check failed: $PR_VERSION is equal to $MAIN_VERSION"
          exit 1