name: Version Check

on:
  pull_request:
    paths:
      - 'package.json'
      - 'version.json'

jobs:
  check-version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Get PR version
        id: pr-version
        run: |
          PR_VERSION=$(jq -r .version package.json)
          echo "PR_VERSION=$PR_VERSION" >> $GITHUB_ENV

      - name: Get main branch version
        id: main-version
        run: |
          git fetch origin main
          git checkout origin/main -- package.json
          MAIN_VERSION=$(jq -r .version package.json)
          echo "MAIN_VERSION=$MAIN_VERSION" >> $GITHUB_ENV

      - name: Compare versions
        run: |
          echo "PR version: $PR_VERSION"
          echo "Main version: $MAIN_VERSION"

          # Split versions into arrays
          IFS='.' read -r -a pr <<< "$PR_VERSION"
          IFS='.' read -r -a main <<< "$MAIN_VERSION"

          for i in 0 1 2; do
            if [ "${pr[i]}" -gt "${main[i]}" ]; then
              echo "PR version is greater. âœ…"
              exit 0
            elif [ "${pr[i]}" -lt "${main[i]}" ]; then
              echo "::error ::PR version ($PR_VERSION) must be greater than main version ($MAIN_VERSION)"
              exit 1
            fi
          done

          # If we reach here, versions are equal
          echo "::error ::PR version ($PR_VERSION) must be greater than main version ($MAIN_VERSION)"
          exit 1